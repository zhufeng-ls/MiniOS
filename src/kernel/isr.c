/* isr.c
 * This file is modified form Bram's Kernel Development Tutorial
 * set up the Interrupt Service Routines, which handle excepitons generated by processor 
 */

#include <debug.h>
#include <fault.h>
#include <idt.h>
#include <irq.h>
#include <print.h>
#include <syscall.h>
#include <type.h>

extern void isr_unknown(); // see loader.asm

void isr_init() {
    fault_init();
    /* treat unkown interrupt as fault */
    int i;
    // 初始化中断服务例程为isr_unknown
    for (i = ISR_IRQ0; i < NIDT; i++) {
        idt_install(i,(uint32_t)isr_unknown, SEL_KCODE << 3, GATE_INT, IDT_PR|IDT_DPL_KERN);
    }

    irq_init();
}

void isr_stub(struct interrupt_frame *r) {
  // printk("int_no: %d\n", r->int_no);
  if (r->int_no < ISR_IRQ0 || r->int_no == ISR_UNKNOWN) {
    fault_handler(r);  // 默认中断处理
  } else if (r->int_no < ISR_IRQ0 + 16) {
    irq_handler(r);  // 指定中断处理
  } else if (r->int_no == ISR_SYSCALL) {
    syscall();  // 系统调用
  } else {
    panic("isr_stub: wrong interrupt number", 0);  // 中断号错误
  }
}
